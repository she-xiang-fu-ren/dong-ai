<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="navbar">
  <nav
          th:data-islogin="true"
          class="navbar navbar-expand-md bg-color-white fixed-top"
  >
    <div class="nav-body">
      <div class="nav-logo-wrap-lg">
        <a class="navbar-logo-wrap" href="/">
          <img class="logo" src="/img/logo.svg" />
          <img src="/img/icon.png" class="logo-lg" alt="" />
        </a>
        <div class="dropdown nav-menu-lg">
        </div>
      </div>
      <div class="nav-right">
        <ul th:if="${!true}">
          <!--  å¾…ç™»å½• -->
          <li class="nav-item">
            <a
                    class="nav-link"
                    href="#"
                    data-toggle="modal"
                    data-target="#loginModal"
            >
              ç™»å½•
            </a>
          </li>
        </ul>
        <ul th:if="${true}" class="nav-right-user">
          <!-- å¢åŠ ä¸€ä¸ª VIP çš„è§’æ ‡ -->
          <li class="nav-item vip">
              <span th:text="æ˜ŸçƒVIPä¼šå‘˜"></span>
              <!-- VIP çš„ SVG -->
              <img src="/img/vip.gif" alt="VIP" />
          </li>

          <!-- å¤´åƒæ¡† -->
          <div class="nav-right-user">
            <div class="nav-user-avatar">
              <img
                        style="border-radius: 50%"
                      class="nav-login-img"
                      th:src="@{/img/123.jpg}"
                      src="https://static.developers.pub/static/img/logo.b2ff606.jpeg"
                      alt=""
                      loading="lazy"
              />
              <div class="nav-user-arrow"></div>
              <div class="nav-user-dropdown">
                <div class="nav-user-dropdown-inner nav-user-dropdown::before">
                  <!-- ä¸‹è½æ¡†å†…å®¹ -->
                  <!--  è°ƒæ•´ä¸ºæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥ç›´æ¥çœ‹åˆ°ç®¡ç†åå°  th:if="${#strings.equalsIgnoreCase(global.user.role, 'admin')}"-->
                  <!-- æœ¬åœ°ç¯å¢ƒçš„æ—¶å€™ä¸æ˜¾ç¤ºï¼Œæœ¬åœ°ç¯å¢ƒçš„æ—¶å€™é€šè¿‡åç«¯ç›´æ¥å¯åŠ¨ç®¡ç†åå° -->
                  <div
                          class="dropdown-divider"
                  ></div>
                  <a
                          th:href="${'/user/home?userId=' + '1'}"
                          class="dropdown-item"
                          href="#"
                  >
                    ä¸ªäººä¸»é¡µ
                  </a>
                  <a id="logoutBtn" href="/logout" class="dropdown-item">ç™»å‡º</a>
                </div>
              </div>
            </div>
          </div>
        </ul>
      </div>
    </div>
  </nav>
  <!-- ç™»å½• Modal -->
  <div
          th:if="${!true}"
          class="modal fade"
          id="loginModal"
          data-backdrop="static"
          data-keyboard="false"
          tabindex="-1"
          role="dialog"
          aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">ç™»å½•æŠ€æœ¯æ´¾ç•…äº«æ›´å¤šæƒç›Š</h6>
          <button
                  type="button"
                  class="close"
                  data-dismiss="modal"
                  aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="auth-body">
            <div class="login-main">
              <!-- åˆ†ä¸ºä¸Šä¸‹ä¸¤éƒ¨åˆ†ï¼Œä¸‹é¢æ˜¯å…¶ä»–ç™»å½•æ¯”å¦‚è¯´ GitHubã€éªŒè¯ç  -->
              <div class="panel">
                <h1 class="title">ç”¨æˆ·åå¯†ç ç™»å½•</h1>
                <!-- ç™»å½•è¡¨å•ã€ç”¨æˆ·åå’Œå¯†ç  -->
                <form id="login-form">
                  <div class="form-group">
                    <input type="text" required autocomplete="off" class="form-control form-control-sm" id="username" placeholder="è¾“å…¥ç”¨æˆ·å">
                  </div>
                  <div class="form-group">
                    <input type="password" required class="form-control form-control-sm" id="password" placeholder="è¾“å…¥å¯†ç ">
                  </div>
                  <button type="submit" class="btn btn-primary btn-block btn-sm">ç™»å½•</button>
                </form>
              </div>
              <div class="other-login-box">
                <div class="oauth-box">
                  <span>å…¶ä»–ç™»å½•ï¼š</span>
                  <div class="oauth">
                    <div class="oauth-bg">
                      <!-- GitHub çš„ log svg -->
                      <svg data-v-52064cc0="" width="24px" height="24px" viewBox="0 0 46 46" version="1.1"
                           xmlns="http://www.w3.org/2000/svg"
                           class="github-icon"><title data-v-52064cc0="">icon_GitHub</title><desc data-v-52064cc0="">Created with sketchtool.</desc><defs data-v-52064cc0=""></defs><g data-v-52064cc0="" id="çŠ¶æ€" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g data-v-52064cc0="" id="æ³¨å†Œ" transform="translate(-758.000000, -600.000000)"><g data-v-52064cc0="" id="Group-4" transform="translate(758.000000, 600.000000)"><rect data-v-52064cc0="" id="Rectangle-314" fill-opacity="0" fill="#D8D8D8" x="0" y="0" width="46" height="46"></rect><path data-v-52064cc0="" d="M5,23.4307576 C5,31.1317497 10.1024923,37.6642712 17.179508,39.9691117 C18.0705582,40.1296159 18.3952722,39.5913918 18.3952722,39.1291397 C18.3952722,38.7161088 18.3799658,37.61933 18.3712193,36.1651618 C13.4174176,37.2180695 12.3722103,33.8282205 12.3722103,33.8282205 C11.5620653,31.8144276 10.3944069,31.2783436 10.3944069,31.2783436 C8.77739677,30.1976152 10.5168579,30.2190158 10.5168579,30.2190158 C12.3044248,30.342069 13.2446741,32.0155929 13.2446741,32.0155929 C14.8332581,34.6788928 17.413477,33.9095426 18.4280715,33.4633409 C18.5898819,32.3376714 19.0501667,31.5693912 19.5585573,31.1338898 C15.6040438,30.6941082 11.4461741,29.198209 11.4461741,22.5190936 C11.4461741,20.6165837 12.1404279,19.0596928 13.2796601,17.8420009 C13.0959835,17.4011493 12.4848215,15.6281127 13.4545902,13.2291098 C13.4545902,13.2291098 14.9491492,12.7604375 18.3515396,15.0160567 C19.7717533,14.6287065 21.2958318,14.4361015 22.8100705,14.4286113 C24.3232158,14.4361015 25.846201,14.6287065 27.2686013,15.0160567 C30.6688051,12.7604375 32.1611774,13.2291098 32.1611774,13.2291098 C33.1331328,15.6281127 32.5219708,17.4011493 32.3393875,17.8420009 C33.4808064,19.0596928 34.1695936,20.6165837 34.1695936,22.5190936 C34.1695936,29.2153294 30.005164,30.6887581 26.0386241,31.1199794 C26.6771189,31.6582035 27.246735,32.7218115 27.246735,34.3482542 C27.246735,36.6777053 27.2248688,38.5577447 27.2248688,39.1291397 C27.2248688,39.5956719 27.5463028,40.1381761 28.4493795,39.9680417 C35.5209286,37.657851 40.6190476,31.1296097 40.6190476,23.4307576 C40.6190476,13.8037149 32.6444218,6 22.8078838,6 C12.9746258,6 5,13.8037149 5,23.4307576 Z" id="Fill-3" fill="#161614"></path></g></g></g></svg>
                    </div>
                  </div>
                </div>
                <a class="clickable" data-toggle="modal" data-target="#registerModal" data-dismiss="modal">
                  ç»‘å®šæ˜Ÿçƒï¼Œç•…äº«VIPæœåŠ¡
                </a>
              </div>
            </div>
            <div class="tabpane-container">

              <div class="explain">
                <bold>è¾“å…¥éªŒè¯ç </bold>
                <span id="code"></span>
                <div><span id="state">æœ‰æ•ˆæœŸäº”åˆ†é’Ÿ ğŸ‘‰</span> <a id="refreshCode">æ‰‹åŠ¨åˆ·æ–°</a></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="agreement-box">
            <div class="mdnice-user-dialog-footer">
              <p>ç™»å½•å³åŒæ„
                <a href="article/detail/141"
                   target="_blank" rel="noopener noreferrer">
                  ç”¨æˆ·åè®®
                </a> å’Œ
                <a href="article/detail/142"
                   target="_blank" rel="noopener noreferrer">
                  éšç§æ”¿ç­–
                </a>
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
  <script src="/js/mock.js"></script>
  <script th:inline="javascript">
    // æ˜¯å¦è‡ªåŠ¨åˆ·æ–°éªŒè¯ç 
    let autoRefresh;
    const stateTag = $('#state'), codeTag = $('#code');

    // ç™»å½•
    $("#login-form").on("submit", function(event) {
      event.preventDefault();

      // è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œæ²¡æœ‰å®šä¹‰ ID
      const username = $("#username").val();
      const password = $("#password").val();

      $.ajax({
        url: "/login/username",
        type: "POST",
        data: {
          username: username,
          password: password
        },
        success: function(response) {
          console.log(response);
          if(response.status.code === 0) {
            // ç™»å½•æˆåŠŸ
            refreshPage();
          } else {
            // ç™»å½•å¤±è´¥
            toastr.error(response.status.msg);
          }
        },
        error: function(error) {
          console.error(error);
          // å‡ºç°é”™è¯¯æ—¶å¦‚ä½•å¤„ç†
        }
      });
    });

    // ç»‘å®šæ˜Ÿçƒ
    $("#register-form").on("submit", function(event) {
      event.preventDefault();

      // è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œæ²¡æœ‰å®šä¹‰ ID
      const registerUser = $('#registerUser').val();
      const starNumber = $("#starNumber").val() | '00000';
      const password = $("#registerPassword").val();
      const invitationCode = $("#invitationCode").val();

      $.ajax({
        url: "/login/register",
        type: "POST",
        data: {
          username: registerUser,
          starNumber: starNumber.toString().padStart(5, '0'), // "00001",
          password: password,
          invitationCode: invitationCode
        },
        success: function(response) {
          console.log(response);
          if(response.status.code === 0) {
            // ç™»å½•æˆåŠŸ
            refreshPage();
          } else {
            // ç™»å½•å¤±è´¥
            toastr.error(response.status.msg);
          }
        },
        error: function(error) {
          console.error(error);
          // å‡ºç°é”™è¯¯æ—¶å¦‚ä½•å¤„ç†
        }
      });
    });



    // å®šä¹‰ä¸€ä¸ªåˆ·æ–°é¡µé¢çš„æ–¹æ³•
    function refreshPage() {
      if (window.location.pathname === "/login") {
        // ç™»å½•æˆåŠŸï¼Œè·³è½¬é¦–é¡µ
        window.location.href = "/";
      } else {
        // åˆ·æ–°å½“å‰é¡µé¢
        window.location.reload();
      }
    }

    /**
     * è®°å½•é•¿è¿æ¥
     * @type {null}
     */
    let sseSource = null;
    let intHook = null;
    let deviceId = null;

    /**
     * å»ºç«‹åŠé•¿è¿æ¥ï¼Œç”¨äºå®ç°è‡ªåŠ¨ç™»å½•
     */
    function buildConnect() {
      if (sseSource != null) {
        try {
          sseSource.close();
        } catch (e) {
          console.log("å…³é—­ä¸Šæ¬¡çš„è¿æ¥", e);
        }
        try {
          window.clearInterval(intHook);
        } catch (e) {
        }
      }

      if(!deviceId) {
        deviceId = getCookie("f-device");
      }
      const subscribeUrl = "/subscribe?deviceId=" + deviceId;
      const source = new EventSource(subscribeUrl);
      sseSource = source;

      source.onmessage = function (event) {
        let text = event.data.replaceAll("\"", "").trim();
        console.log("receive: " + text);

        let newCode;
        if (text.startsWith('refresh#')) {
          // åˆ·æ–°éªŒè¯ç 
          newCode = text.substring(8).trim();
          codeTag.text(newCode);
          stateTag.text("å·²åˆ·æ–° ");
        } else if (text === 'scan') {
          // äºŒç»´ç æ‰«æ
          stateTag.text("å·²æ‰«æ ");
        } else if (text.startsWith('login#')) {
          // ç™»å½•æ ¼å¼ä¸º login#cookie
          console.log("ç™»å½•æˆåŠŸ,ä¿å­˜cookie", text)
          document.cookie = text.substring(6);
          source.close();
          refreshPage();
        } else if (text.startsWith("init#")) {
          newCode = text.substring(5).trim();
          codeTag.text(newCode);
          console.log("åˆå§‹åŒ–éªŒè¯ç : ", newCode);
        }

        if (newCode != null) {
          try {
            window.clearInterval(intHook);
          } catch (e) {}
        }

      };

      source.onopen = function (evt) {
        deviceId = getCookie("f-device");
        console.log("å¼€å§‹è®¢é˜…, è®¾å¤‡id=", deviceId, evt);
      }
      source.onerror = function (e, evt) {
        console.log("è¿æ¥é”™è¯¯ï¼Œé‡æ–°å¼€å§‹", e, evt)
        stateTag.text("è¿æ¥ä¸­æ–­,è¯·åˆ·æ–°é‡è¿");
        buildConnect(code);
      }

      fetchCodeCnt = 0;
      intHook = self.setInterval("fetchCode()", 1000);
    }

    let fetchCodeCnt = 0;
    function fetchCode() {
      if (deviceId) {
        if (++fetchCodeCnt > 5) {
          // ä¸ºäº†é¿å…ä¸åœçš„å‘åç«¯å‘èµ·è¯·æ±‚ï¼Œåšä¸€ä¸ªæœ€å¤§çš„é‡è¯•è®¡æ•°é™åˆ¶
          try {
            window.clearInterval(intHook);
          } catch (e) {}
          return;
        }

        $.ajax({
          url: "/login/fetch?deviceId=" + deviceId, type: "get", dataType: "text", success: function (data) {
            console.log("data>>>>>>>>: ", data);
            if (data != 'fail') {
              codeTag.text(data);
              try {
                window.clearInterval(intHook);
              } catch (e) {}
            }
          },
          error: function (e) {
            console.log("some error! ", e);
          }
        });
      } else {
        console.log("deviceIdæœªè·å–ï¼Œç¨åå†è¯•!");
      }
    }

    function refreshCode() {
      $.ajax({
        url: "/login/refresh?deviceId=" + deviceId, dataType: "json", type: "get", success: function (data) {
          const code = data['result']['code'];
          const reconnect = data['result']['reconnect']
          console.log("éªŒè¯ç åˆ·æ–°å®Œæˆ: ", data);

          if (reconnect) {
            // é‡æ–°å»ºç«‹è¿æ¥
            buildConnect();
            $('#state').text("å·²åˆ·æ–°!");
          } else if(code) {
            if (codeTag.text() !== code) {
              console.log("ä¸»åŠ¨åˆ·æ–°éªŒè¯ç !");
              codeTag.text(code);
              stateTag.text("å·²åˆ·æ–°!");
            } else {
              console.log("éªŒè¯ç å·²åˆ·æ–°äº†!");
            }
          }
        }
      })
    }
    $('#loginModal').on('show.bs.modal', function () {
      console.log("ç™»å½•å¼¹çª—å·²å±•ç¤º!");
      buildConnect();
    })
    $('#refreshCode').click(() => {
      refreshCode();
    })

    // è·å–ç”¨æˆ·å¤´åƒå’Œä¸‹è½æ¡†å…ƒç´ 
    const navUserAvatar = document.querySelector('.nav-user-avatar');
    const navUserDropdown = document.querySelector('.nav-user-dropdown');

    if (navUserAvatar != null && navUserDropdown != null) {
      // å½“é¼ æ ‡ç‚¹å‡»ç”¨æˆ·å¤´åƒæ—¶æ˜¾ç¤ºä¸‹è½æ¡†
      navUserAvatar.addEventListener('click', () => {
        // å¦‚æœä¸‹è½æ¡†æ˜¯éšè—çš„ï¼Œåˆ™æ˜¾ç¤ºï¼›å¦‚æœå·²ç»æ˜¾ç¤ºï¼Œåˆ™ä¸å¤„ç†
        if (navUserDropdown.style.display === 'none' || navUserDropdown.style.display === '') {
          navUserDropdown.style.display = 'block';
        }
      });
      // ç‚¹å‡»å…¶ä»–åŒºåŸŸæ—¶éšè—ä¸‹è½æ¡†
      document.addEventListener('click', (event) => {
        // å¦‚æœç‚¹å‡»çš„åŒºåŸŸä¸æ˜¯ç”¨æˆ·å¤´åƒå’Œä¸‹è½æ¡†ï¼Œåˆ™éšè—ä¸‹è½æ¡†
        if (!navUserAvatar.contains(event.target) && !navUserDropdown.contains(event.target)) {
          navUserDropdown.style.display = 'none';
        }
      });
    }
  </script>
</div>
</html>
